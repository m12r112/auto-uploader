name: Fetch videos and audio

on:
  workflow_dispatch:
  schedule:
    - cron: '0 7 * * *'

jobs:
  fetch-videos:
    runs-on: ubuntu-latest

    # لا نبقي إلا SERVICE_ACCOUNT_KEY هنا
    env:
      SERVICE_ACCOUNT_KEY: ${{ secrets.SERVICE_ACCOUNT_KEY }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Write service_account.key
        run: |
          python - << 'PY'
import os, json, textwrap
key = json.loads(os.environ["SERVICE_ACCOUNT_KEY"])
with open("service_account.key", "w") as f:
    json.dump(key, f)
print("✅ service_account.key written")
PY

      # ⬇️⬇️ خطوة تشخيص المتغيّرات
      - name: DEBUG –- show env vars
        env:
          PEXELS_API_KEY:  ${{ secrets.PEXELS_API_KEY }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          echo "PEXELS_API_KEY = '${PEXELS_API_KEY}'"
          echo "PEXELS_API_KEY length = ${#PEXELS_API_KEY}"
          echo "DRIVE_FOLDER_ID  = '${DRIVE_FOLDER_ID}'"
          echo "DRIVE_FOLDER_ID length = ${#DRIVE_FOLDER_ID}"

      # ⬇️⬇️ الخطوة الفعلية
      - name: Run fetch-and-upload script
        env:
          PEXELS_API_KEY:  ${{ secrets.PEXELS_API_KEY }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: python daily_fetch_and_upload.py
